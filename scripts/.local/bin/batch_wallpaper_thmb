#!/usr/bin/env bash

# Auto generate rofi background
WALLPAPER_FOLDER="$HOME/Pictures/wallpapers"

if [[ ! -d "$WALLPAPER_FOLDER" ]]; then
    notify-send "Wallpaper" "Error: Folder $WALLPAPER_FOLDER does not exists!"
    exit 1
fi

image_extensions=("*.jpg" "*.jpeg" "*.png" "*.webp" "*.bmp" "*.tiff")

thmbDir=~/.cache/noon
mkdir -p $thmbDir

process_image() {
    local current_wall="$1"
    local wall_name=$(basename "$current_wall")
    wall_name="${wall_name%.*}"

    if [[ -f "$thmbDir/${wall_name}.thmb" &&
          -f "$thmbDir/${wall_name}.sqre" &&
          -f "$thmbDir/${wall_name}.blur" ]]; then
        return
    fi

    magick "${current_wall}" -strip -resize 1000 -gravity center -extent 1000 -quality 90 "${thmbDir}/${wall_name}.thmb"
    magick "${current_wall}" -strip -thumbnail 500x500^ -gravity center -extent 500x500 "${thmbDir}/${wall_name}.sqre"
    magick "${current_wall}" -strip -scale 10% -blur 0x3 -resize 100% "${thmbDir}/${wall_name}.blur"
}

for ext in "${image_extensions[@]}"; do
    for file in "$WALLPAPER_FOLDER"/$ext; do
        if [[ -f "$file" ]]; then
            process_image "$file"
        fi
    done
done

